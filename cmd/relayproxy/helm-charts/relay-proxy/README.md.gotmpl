{{ template "chart.header" . }}
{{ template "chart.badgesSection" . }}

{{ template "chart.description" . }}

## How to use the chart

Please replace the keys `relayproxy.config` in  the `Values.yaml` to fit
your configuration. This file will be stored as `configmap` in your cluster and
be mount as a volume for the `relay-proxy`.

After changing the working directory to `cmd/relayproxy/helm-charts/relay-proxy`,
run the below command:

```shell
helm install . --name-template=go-feature-flag-relay-proxy
```

It will install the chart in your cluster.

{{ template "chart.homepageLine" . }}

{{ template "chart.maintainersSection" . }}

{{ template "chart.sourcesSection" . }}

{{ define "chart.valueDefaultColumnRender" }}
{{- $defaultValue := (default .Default .AutoDefault)  -}}
{{- $notationType := .NotationType }}
{{- if (and (hasPrefix "`" $defaultValue) (hasSuffix "`" $defaultValue) ) -}}
{{- $defaultValue = (toPrettyJson (fromJson (trimAll "`" (default .Default .AutoDefault) ) ) ) -}}
{{- $notationType = "json" }}
{{- end -}}
{{- if (eq $notationType "tpl" ) }}
<pre lang="{{ $notationType }}">
{{ .Key }}: |
{{- $defaultValue | nindent 2 }}
</pre>
{{- else if (eq $notationType "email") }}
<a href="mailto:{{ $defaultValue }}" style="color: green;">"{{ $defaultValue }}"</a>
{{- else }}
<pre lang="{{ $notationType }}">
{{ $defaultValue }}
</pre>
{{- end }}
{{ end }}

{{ define "chart.typeColumnRender" }}
{{- if (eq .Type "string/email") }}
<a href="#stringemail" title="{{- template "chart.valuetypes.email" -}}">{{.Type}}</a>
{{- else if (eq .Type "k8s/storage/persistent-volume/access-modes" )}}
<a target="_blank" 
   href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes"
   >{{- .Type }}</a>
{{- else }}
{{ .Type }}
{{- end }}
{{ end }}

{{ define "chart.valuesTableHtml" }}
<table>
	<thead>
		<th>Key</th>
		<th>Type</th>
		<th>Default</th>
		<th>Description</th>
	</thead>
	<tbody>
	{{- range .Values }}
		<tr>
			<td id="{{ .Key | replace "." "--" }}">
				<a href="./values.yaml#L{{ .LineNumber }}">{{ .Key }}</a>
            </td>
			<td>
				{{- template "chart.typeColumnRender" . -}}
            </td>
			<td>
				<div style="max-width: 300px;">{{ template "chart.valueDefaultColumnRender" . }}</div>
			</td>
			<td>
				{{ if .Description }}{{ .Description }}{{ else }}{{ .AutoDescription }}{{ end }}
			</td>
		</tr>
	{{- end }}
	</tbody>
</table>
{{ end }}

{{ template "chart.valuesSectionHtml" . }}

## Advanced Configuration

You can edit the `values.yaml` file to enable an ingress or the autoscaling.

### Monitoring Port Configuration

The relay proxy supports exposing monitoring endpoints (health checks, metrics) on a separate port from the main service. This is configured by adding `monitoringPort` to your relay proxy configuration:

```yaml
relayproxy:
  config: |
    listen: 1031
    monitoringPort: 1032
    pollingInterval: 1000
    logLevel: info
    # ... other config
```

**Default behavior:** If `monitoringPort` is not specified in the config, monitoring endpoints will be served on the same port as the main service.

When a separate monitoring port is configured:
- A separate service (`<release-name>-relay-proxy-monitoring`) is created for monitoring endpoints
- Health checks and readiness probes use the monitoring port
- Both the main service port and monitoring port are exposed on the pod

**Port logic:**
- If `monitoringPort` is specified in the config, health checks use that port and a separate monitoring service is created
- Otherwise, health checks use the main service port
