# ---------------------------------------
# Bump module dependency is a workflow that bumps the dependency of a module to the latest version.
# This is a reusable workflow and is used by the release-please workflow to bump the dependency of the module to the latest version.
# ---------------------------------------
name: bump module dependency
permissions:
  actions: read
  contents: read

on:
  workflow_call:
    inputs:
      modulePath: { type: string, required: true }
      version: { type: string, required: true }
      goModDirectoryPath: { type: string, required: false, default: "." }
    secrets:
      token: { required: true }

jobs:
  bump-module:
    name: Bump module dependency ${{ inputs.modulePath }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: ${{ inputs.goModDirectoryPath }}/go.mod
          check-latest: true

      - name: Update internal module
        env:
          VERSION: ${{ inputs.version }}
          MODULE_PATH: ${{ inputs.modulePath }}
          GO_MOD_DIRECTORY_PATH: ${{ inputs.goModDirectoryPath }}
        run: |
          cd ${GO_MOD_DIRECTORY_PATH}
          export GOWORK=off
          go get github.com/thomaspoignant/go-feature-flag/${MODULE_PATH}@v${VERSION}
          go mod tidy
          go mod vendor
          go mod verify

      - name: Create Pull Request to bump module
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        env:
          VERSION: ${{ inputs.version }}
          MODULE_PATH: ${{ inputs.modulePath }}
          GO_MOD_DIRECTORY_PATH: ${{ inputs.goModDirectoryPath }}
        with:
          branch: bump-module-${{ env.GO_MOD_DIRECTORY_PATH }}-${{ env.MODULE_PATH}}-${{ env.VERSION }}
          title: "chore(dependency): Bump module ${{ env.MODULE_PATH }} ${{ env.VERSION }}"
          body: |
            Automated pull request to bump module ${{ env.MODULE_PATH}} ${{ env.VERSION }}
          commit-message: "chore(dependency): Bump module ${{ env.MODULE_PATH}} ${{ env.VERSION }}"
          assignees: thomaspoignant
          draft: false
          signoff: true
          delete-branch: true
          base: main
          labels: automerge
          token: ${{ secrets.token }}
