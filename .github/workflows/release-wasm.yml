name: Release-wasm
on:
  push:
    tags:
      - "cmd/wasm/v*"

permissions:
  contents: read
  actions: read

jobs:
  wasm-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Extract version from tag
        run: |
          TAG_NAME="${{ github.ref }}"
          VERSION=$(echo $TAG_NAME | awk -F '/' '{print $NF}' | sed 's/^v//')
          echo "tag_name_full=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Echo Release wasm version
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          echo "Release wasm version: ${VERSION}"
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
      - name: Setup go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod
          check-latest: true
      - uses: acifani/setup-tinygo@db56321a62b9a67922bb9ac8f9d085e218807bb3 # v2.0.1
        with:
          tinygo-version: "0.37.0"
      - name: Release WASM
        env:
          VERSION: ${{ env.VERSION }}
        run: ./.github/ci-scripts/release_wasm.sh "$VERSION"
      - name: Upload assets
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2.4.2
        env:
          VERSION: ${{ env.VERSION }}
        with:
          files: |
            ./out/release-wasm/gofeatureflag-evaluation_${VERSION}.wasi
            ./out/release-wasm/gofeatureflag-evaluation_${VERSION}.wasm

      - name: Checkout wasm-releases repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          repository: go-feature-flag/wasm-releases
          path: wasm-releases
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      - name: Copy WASM files to wasm-releases repository
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          mkdir -p wasm-releases/evaluation
          cp ./out/release-wasm/gofeatureflag-evaluation_${VERSION}.wasi wasm-releases/evaluation/
          cp ./out/release-wasm/gofeatureflag-evaluation_${VERSION}.wasm wasm-releases/evaluation/

      - name: Create Pull Request to wasm-releases
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        env:
          VERSION: ${{ env.VERSION }}
        with:
          branch: publish-wasm-evaluation-${{ env.VERSION }}
          title: "feat: Publish WASM files for ${{ env.VERSION }}"
          body: |
            Automated pull request to publish evaluation WASM files for release ${{ env.VERSION }}

            This PR includes:
            - gofeatureflag-evaluation_${{ env.VERSION }}.wasi
            - gofeatureflag-evaluation_${{ env.VERSION }}.wasm
          commit-message: Publish evaluation WASM files for ${{ env.VERSION }}
          assignees: thomaspoignant
          draft: false
          signoff: true
          delete-branch: true
          labels: automerge
          path: wasm-releases
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

