name: Bump WASM version in OpenFeature contrib repos

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'WASM version to bump to (e.g. "v2.0.0" or "2.0.0")'
        required: true
        type: string

permissions:
  contents: read
  actions: read

jobs:
  bump-wasm-contrib:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout go-feature-flag repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - name: Create out directory
        run: make create-out-dir

      - name: Normalize input version
        id: normalize_version
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+([\-+][0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid version: $VERSION"
            echo 'Expected something like "v2.0.0" or "2.0.0".'
            exit 1
          fi          
          echo "wasm_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using wasm_version=$VERSION"

      - name: Checkout OpenFeature java contrib repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: open-feature/java-sdk-contrib
          path: out/contrib/java-sdk-contrib
          token: ${{ secrets.OPENFEATURE_PR_PAT }}
          fetch-depth: 1
          submodules: true

      - name: Checkout OpenFeature dotnet contrib repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: open-feature/dotnet-sdk-contrib
          path: out/contrib/dotnet-sdk-contrib
          token: ${{ secrets.OPENFEATURE_PR_PAT }}
          fetch-depth: 1
          submodules: true

      - name: Checkout OpenFeature JS contrib repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: open-feature/js-sdk-contrib
          path: out/contrib/js-sdk-contrib
          token: ${{ secrets.OPENFEATURE_PR_PAT }}
          fetch-depth: 1
          submodules: true

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: ./.github/ci-scripts/bump-wasm-contrib/go.mod
          check-latest: true

      - name: Update submodule dotnet contrib repository
        run: cd out/contrib/dotnet-sdk-contrib && git submodule update --remote src/OpenFeature.Providers.GOFeatureFlag/wasm-releases

      - name: Update submodule js contrib repository
        run: cd out/contrib/js-sdk-contrib && git submodule update --remote libs/providers/go-feature-flag/wasm-releases

      - name: Update submodule java contrib repository
        run: cd out/contrib/java-sdk-contrib && git submodule update --remote providers/go-feature-flag/wasm-releases

      - name: Bump WASM version in discovered files
        run: VERSION=${{ steps.normalize_version.outputs.wasm_version }} make bump-wasm-contrib

      - name: Create Pull Request to open-feature/java-sdk-contrib
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          path: out/contrib/java-sdk-contrib
          branch: bump-wasm-${{ steps.normalize_version.outputs.wasm_version }}
          title: "chore(go-feature-flag): Bump WASM module to ${{ steps.normalize_version.outputs.wasm_version }}"
          body: |
            Automated pull request to bump the GO Feature Flag evaluation WASM version to ${{ steps.normalize_version.outputs.wasm_version }}.
            This PR is automatically generated by the [go-feature-flag](https://github.com/thomaspoignant/go-feature-flag) repository.
          commit-message: "chore: bump WASM to ${{ steps.normalize_version.outputs.wasm_version }}"
          signoff: true
          delete-branch: true
          token: ${{ secrets.OPENFEATURE_PR_PAT }}

      - name: Create Pull Request to open-feature/dotnet-sdk-contrib
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          path: out/contrib/dotnet-sdk-contrib
          branch: bump-wasm-${{ steps.normalize_version.outputs.wasm_version }}
          title: "chore(go-feature-flag): bump WASM to ${{ steps.normalize_version.outputs.wasm_version }}"
          body: |
            Automated pull request to bump the GO Feature Flag evaluation WASM version to ${{ steps.normalize_version.outputs.wasm_version }}.
            This PR is automatically generated by the [go-feature-flag](https://github.com/thomaspoignant/go-feature-flag) repository.
          commit-message: "chore: bump WASM to ${{ steps.normalize_version.outputs.wasm_version }}"
          signoff: true
          delete-branch: true
          token: ${{ secrets.OPENFEATURE_PR_PAT }}

      - name: Create Pull Request to open-feature/js-sdk-contrib
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          path: out/contrib/js-sdk-contrib
          branch: bump-wasm-${{ steps.normalize_version.outputs.wasm_version }}
          title: "chore(go-feature-flag): bump WASM to ${{ steps.normalize_version.outputs.wasm_version }}"
          body: |
            Automated pull request to bump the GO Feature Flag evaluation WASM version to ${{ steps.normalize_version.outputs.wasm_version }}.
            This PR is automatically generated by the [go-feature-flag](https://github.com/thomaspoignant/go-feature-flag) repository.
          commit-message: "chore: bump WASM to ${{ steps.normalize_version.outputs.wasm_version }}"
          signoff: true
          delete-branch: true
          token: ${{ secrets.OPENFEATURE_PR_PAT }}

